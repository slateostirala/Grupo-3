<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Backing up ownCloud &#8212; ownCloud 10.0.10 Server Administration Manual 10.0.10 documentation</title>
    <link rel="stylesheet" href="../_static/" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/main.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/styles.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '10.0.10',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.1.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="How to Upgrade Your ownCloud Server" href="upgrade.html" />
    <link rel="prev" title="Maintenance Mode Configuration" href="enable_maintenance.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#1d2d44">

  </head>
  <body>


<div class="wrap container not-front">
  <div class="content row">
  <main class="main">
    <div class="row page-content-header">
      <div class="col-md-5 col-md-offset-7">
      
        <form class="headersearch" style="margin-bottom:-3px;" action="../search.html" method="get">
        <input type="text" value="" name="q" id="q" class="form-control" /> 
        <button  class="btn btn-default" type="submit" id="searchsubmit">Search</button>
        </form>
      
      </div>
    </div>
    
			<div class="row">
				<div class="col-md-3">
					<div class="sidebar">
							<div class="menu-support-container">
								<ul id="menu-support" class="menu">
									<ul>
										
<li><a href="../contents.html">Table of Contents</a></li>
									</ul>
                  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release_notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../whats_new_admin.html">What’s New in ownCloud 10.0.10</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../upgrading/index.html">Upgrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuration/index.html">Configuration</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Maintenance</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="enable_maintenance.html">Maintenance Mode Configuration</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Backing up ownCloud</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#backing-up-the-config-and-data-directories">Backing Up the config/ and data/ Directories</a></li>
<li class="toctree-l3"><a class="reference internal" href="#backup-database">Backup Database</a></li>
<li class="toctree-l3"><a class="reference internal" href="#restoring-files-from-backup-when-encryption-is-enabled">Restoring Files From Backup When Encryption Is Enabled</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="upgrade.html">How to Upgrade Your ownCloud Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_upgrade.html">Upgrade ownCloud From Packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="update.html">Upgrading ownCloud with the Updater App</a></li>
<li class="toctree-l2"><a class="reference internal" href="manual_upgrade.html">Manual ownCloud Upgrade</a></li>
<li class="toctree-l2"><a class="reference internal" href="restore.html">Restoring ownCloud</a></li>
<li class="toctree-l2"><a class="reference internal" href="migrating.html">Migrating to a Different Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="manually-moving-data-folders.html">How To Manually Move a Data Directory</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../issues/index.html">Issues and Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../enterprise/index.html">Enterprise Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appliance/index.html">The ownCloud X Appliance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index.html">FAQ</a></li>
</ul>

								</ul>
							</div>
					</div>
				</div>
        

				<div class="col-md-9">
					<div class="page-content">
            
<ul class="prevnext-title list-unstyled list-inline">
  <li class="prev">
    <a href="enable_maintenance.html" title="Previous Chapter: Maintenance Mode Configuration"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm">&laquo; Maintenance M...</span>
    </a>
  </li>
  <li class="next">
    <a href="upgrade.html" title="Next Chapter: How to Upgrade Your ownCloud Server"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm">How to Upgrad... &raquo;</span>
    </a>
  </li>
</ul>
						
  <div class="section" id="backing-up-owncloud">
<h1>Backing up ownCloud<a class="headerlink" href="#backing-up-owncloud" title="Permalink to this headline">¶</a></h1>
<p>When you backup your ownCloud server, there are four things that you need to copy:</p>
<ol class="arabic simple">
<li>Your <code class="docutils literal"><span class="pre">config/</span></code> directory.</li>
<li>Your <code class="docutils literal"><span class="pre">data/</span></code> directory.</li>
<li>Your ownCloud database.</li>
<li>Your custom theme files, if you have any. (See <a class="reference external" href="https://doc.owncloud.org/server/latest/developer_manual/core/theming.html">Theming ownCloud</a>)</li>
</ol>
<p>When you install your ownCloud server from our <a class="reference external" href="https://download.owncloud.org/download/repositories/stable/owncloud/">Open Build Service</a> packages (or from distro packages, which we do not recommend) <strong>do not backup your ownCloud server files</strong>, which are the other files in your <code class="docutils literal"><span class="pre">owncloud/</span></code> directory such as <code class="docutils literal"><span class="pre">core/</span></code>, <code class="docutils literal"><span class="pre">3rdparty/</span></code>, <code class="docutils literal"><span class="pre">apps/</span></code>, <code class="docutils literal"><span class="pre">lib/</span></code>, and all the rest of the ownCloud files. If you restore these files from backup they may not be in sync with the current package versions, and will fail the code integrity check. This may also cause other errors, such as white pages.</p>
<p>When you install ownCloud from the source tarballs this will not be an issue, and you can safely backup your entire ownCloud installation, with the exception of your ownCloud database. Databases cannot be copied, but you must use the database tools to make a correct database dump.</p>
<p>To restore your ownCloud installation from backup, see <a class="reference internal" href="restore.html"><span class="doc">Restoring ownCloud</span></a> .</p>
<div class="section" id="backing-up-the-config-and-data-directories">
<span id="backing-up-the-config-and-data-directories-label"></span><h2>Backing Up the config/ and data/ Directories<a class="headerlink" href="#backing-up-the-config-and-data-directories" title="Permalink to this headline">¶</a></h2>
<p>Simply copy your <code class="docutils literal"><span class="pre">config/</span></code> and <code class="docutils literal"><span class="pre">data/</span></code> folder to a place outside of your ownCloud environment. This example uses <code class="docutils literal"><span class="pre">rsync</span></code> to copy the two directories to <code class="docutils literal"><span class="pre">/oc-backupdir</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">rsync</span> <span class="o">-</span><span class="n">Aax</span> <span class="n">config</span> <span class="n">data</span> <span class="o">/</span><span class="n">oc</span><span class="o">-</span><span class="n">backupdir</span><span class="o">/</span>
</pre></div>
</div>
<p>There are many ways to backup normal files, and you may use whatever method you are accustomed to.</p>
</div>
<div class="section" id="backup-database">
<span id="backup-database-label"></span><h2>Backup Database<a class="headerlink" href="#backup-database" title="Permalink to this headline">¶</a></h2>
<p>You can’t just copy a database, but must use the database tools to make a correct database dump.</p>
<div class="section" id="mysql-mariadb">
<h3>MySQL/MariaDB<a class="headerlink" href="#mysql-mariadb" title="Permalink to this headline">¶</a></h3>
<p>MySQL or MariaDB, which is a drop-in MySQL replacement, is the recommended database engine. To backup MySQL/MariaDB:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>mysqldump --single-transaction -h [server] -u [username] -p [password] [db_name] &gt; owncloud-dbbackup_`date +&quot;%Y%m%d&quot;`.bak
</pre></div>
</div>
<p>Example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>mysqldump --single-transaction -h localhost -u username -p password owncloud &gt; owncloud-dbbackup_`date +&quot;%Y%m%d&quot;`.bak
</pre></div>
</div>
</div>
<div class="section" id="sqlite">
<h3>SQLite<a class="headerlink" href="#sqlite" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default"><div class="highlight"><pre><span></span>sqlite3 data/owncloud.db .dump &gt; owncloud-dbbackup_`date +&quot;%Y%m%d&quot;`.bak
</pre></div>
</div>
</div>
<div class="section" id="postgresql">
<h3>PostgreSQL<a class="headerlink" href="#postgresql" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default"><div class="highlight"><pre><span></span>PGPASSWORD=&quot;password&quot; pg_dump [db_name] -h [server] -U [username] -f owncloud-dbbackup_`date +&quot;%Y%m%d&quot;`.bak
</pre></div>
</div>
</div>
</div>
<div class="section" id="restoring-files-from-backup-when-encryption-is-enabled">
<h2>Restoring Files From Backup When Encryption Is Enabled<a class="headerlink" href="#restoring-files-from-backup-when-encryption-is-enabled" title="Permalink to this headline">¶</a></h2>
<p>If you need to restore files from backup, which were backed up when encryption
was enabled, here’s how to do it.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is effective from at least version v8.2.7 of ownCloud onwards. Also,
this is <strong>not officially supported</strong>. ownCloud officially supports either
restoring the full backup or restoring nothing — not restoring individual
parts of it.</p>
</div>
<ol class="arabic simple">
<li>Restore the file from backup.</li>
<li>Restore the file’s encryption keys from your backup.</li>
<li>Run <code class="docutils literal"><span class="pre">occ</span> <span class="pre">files:scan</span></code>; this makes the scanner find it.</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>In the DB it will:</p>
<ul class="last simple">
<li>Have the “size” set to the encrypted size, which is wrong (and bigger);</li>
<li>The “encrypted” flag will be set to 0</li>
</ul>
</div>
<ol class="arabic simple" start="4">
<li><a class="reference internal" href="#retrieve-encrypted-flag-value-label"><span class="std std-ref">Retrieve the encrypted flag value</span></a>.</li>
<li>Update the encrypted flag.</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There’s no need to update the encrypted flag for files in either
“files_versions” or “files_trashbin”, because these aren’t scanned or found
by <code class="docutils literal"><span class="pre">occ</span> <span class="pre">files:scan</span></code>.</p>
</div>
<ol class="arabic simple" start="6">
<li>Download the file once as the user; the file’s size will be corrected
automatically.</li>
</ol>
<p>This process might not be suitable across all environments.
If it’s not suitable for yours, you might need to run an OCC command that does the scanning.
But, that will require the user’s password or recovery key.</p>
<div class="section" id="retrieve-the-encrypted-flag-value">
<span id="retrieve-encrypted-flag-value-label"></span><h3>Retrieve the Encrypted Flag Value<a class="headerlink" href="#retrieve-the-encrypted-flag-value" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">In the backup database, retrieve the <code class="docutils literal"><span class="pre">numeric_id</span></code> value for <a class="reference external" href="https://github.com/owncloud/core/wiki/Storage-IDs">the storage</a>
where the file was located from the <code class="docutils literal"><span class="pre">oc_storages</span></code> table and store the value
for later reference.</p>
<p>For example, if you have the following in your <code class="docutils literal"><span class="pre">oc_storages</span></code> table, then
<code class="docutils literal"><span class="pre">numeric_id</span></code> you should use is <code class="docutils literal"><span class="pre">3</span></code>, if you need to restore a file for <code class="docutils literal"><span class="pre">user1</span></code>.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">+--------------------------------+------------+-----------+--------------+</span>
<span class="o">|</span> <span class="nb">id</span>                             <span class="o">|</span> <span class="n">numeric_id</span> <span class="o">|</span> <span class="n">available</span> <span class="o">|</span> <span class="n">last_checked</span> <span class="o">|</span>
<span class="o">+--------------------------------+------------+-----------+--------------+</span>
<span class="o">|</span> <span class="n">home</span><span class="p">::</span><span class="n">admin</span>                    <span class="o">|</span>          <span class="mi">1</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span>         <span class="n">NULL</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">local</span><span class="p">::</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">owncloud</span><span class="o">/</span><span class="n">data</span><span class="o">/</span> <span class="o">|</span>          <span class="mi">2</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span>         <span class="n">NULL</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">home</span><span class="p">::</span><span class="n">user1</span>                    <span class="o">|</span>          <span class="mi">3</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span>         <span class="n">NULL</span> <span class="o">|</span>
<span class="o">+--------------------------------+------------+-----------+--------------+</span>
</pre></div>
</div>
</li>
<li><p class="first">In the live database instance, find the <code class="docutils literal"><span class="pre">fileid</span></code> of the file to restore by
running the query below, substituting the placeholders for the retrieved
values, and store the value for later reference.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">fileid</span>
<span class="n">FROM</span> <span class="n">oc_filecache</span>
<span class="n">WHERE</span> <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;path/to/the/file/to/restore&#39;</span>
  <span class="n">AND</span> <span class="n">storage</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">numeric_id</span><span class="o">&gt;</span>
</pre></div>
</div>
</li>
<li><p class="first">Retrieve the backup, which includes the data folder and database.</p>
</li>
<li><p class="first">Retrieve the required file from your backup and copy it to the real instance.</p>
</li>
<li><p class="first">In the backup database, retrieve the file’s <code class="docutils literal"><span class="pre">encrypted</span></code> value, by running
the query below and store the value for later reference.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">encrypted</span>
<span class="n">FROM</span> <span class="n">oc_filecache</span>
<span class="n">WHERE</span> <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;path/to/the/file/to/restore&#39;</span>
  <span class="n">AND</span> <span class="n">storage</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">numeric_id</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>This assumes the storage was the same and the file was in the same location.
If not, you will need to track down where the file was before.</p>
</li>
<li><p class="first">Update the live database instance with retrieved information, by running the
following query, substituting the placeholders for the retrieved values:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">UPDATE</span> <span class="n">oc_filecache</span>
 <span class="n">SET</span> <span class="n">encrypted</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">encrypted</span><span class="o">&gt;</span>
 <span class="n">WHERE</span> <span class="n">fileid</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">fileid</span><span class="o">&gt;.</span>
</pre></div>
</div>
</li>
</ol>
</div>
</div>
</div>


            
<ul class="prevnext-title list-unstyled list-inline">
  <li class="prev">
    <a href="enable_maintenance.html" title="Previous Chapter: Maintenance Mode Configuration"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm">&laquo; Maintenance M...</span>
    </a>
  </li>
  <li class="next">
    <a href="upgrade.html" title="Next Chapter: How to Upgrade Your ownCloud Server"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm">How to Upgrad... &raquo;</span>
    </a>
  </li>
</ul>
					</div>
				</div>
			</div>
  </main>  
  </div>
</div>
  </body>
</html>